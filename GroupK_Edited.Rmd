---
title: "Group K 1"
output: pdf_document
date: "2024-11-30"
---

```{r setup}
# Load required libraries
library(tidyverse)
library(lme4)
library(glmnet)
library(ggplot2)
```


# Load Data
```{r load-data}
# Read dataset
juveniles <- read_csv("autumn_juveniles.csv")

# Preview the dataset
head(juveniles)
```


# Variable Descriptions
- `individual`: Unique ID of the squirrel.
- `litter_id`: ID of the litter the squirrel belongs to.
- `sex`: Sex of the individual ('M' for male, 'F' for female).
- `year`: Year of observation.
- `field_bdate`: Birth date of the squirrel in the field.
- `grid`: Location grid where the squirrel was observed.
- `growth`: Growth rate of the individual (grams per unit timw).
- `survived_200d`: Whether the individual survived for 200 days (1 for yes, 0 for no).
- `owner`: Description of territory ownership status.
- `Std.BD`: Standardized birth date.
- `Std.growth`: Standardized growth rate.
- `Std.lynx`: Standardized abundance of lynx predators.
- `Std.hare.fall`: Standardized abundance of hares in the fall.
- `Std.mustelid`: Standardized abundance of mustelid predators.
- `Std.Cleth`: Standardized abundance of red-backed voles (Clethrionomys).
- `z.density`: Standardized population density (unitless, z-score).
- `z.cones`: Standardized cone abundance (proxy for food availability).
- `z.temp`: Standardized mean temperature (unitless, z-score).


# Data Preparation

## Handle missing or invalid data
```{r data-cleaning}
# Handle missing or invalid data
juveniles <- juveniles %>%
  drop_na(sex, Std.growth, Std.BD, z.cones, z.density, z.temp, 
          Std.lynx, Std.mustelid, Std.hare.fall, Std.Cleth)

# Add new columns for modeling purposes
juveniles_data <- juveniles %>% 
  # Indicate territory acquisition status: 1 for "acquired territory", 
  # 0 otherwise
  mutate(acquired_terr = case_when(owner == "acquired territory" ~ 1, 
                                   TRUE ~ 0) ) %>% 
  # Encode sex as numeric: 1 for male, 0 for female 
  # (useful for Lasso regression)
  mutate(sex01 = case_when(sex == "M" ~ 1, TRUE ~ 0))

# Preview the processed data to confirm new columns were added
head(juveniles_data)
```


# Hypothesis Testing

## Hypothesis: Male and female juvenile North American red squirrels (*Tamiasciurus hudsonicus*) differ in their likelihood of acquiring a territory and sex is the biggest factor that affects whether they can acquire a territory.

### Prediction 1: One sex (male or female) might have a higher likelihood of acquiring a territory.
```{r hypothesis-testing}
# Perform logistic regression: Prediction 1
model_sex <- glm(acquired_terr ~ sex, 
                 family = "binomial", 
                 data = juveniles_data)

# Summarize the model results
summary(model_sex)
```

### Results Interpretation:
- `sexM`: Coefficient = -0.39008
- Interpretation: Males have lower odds of acquiring a territory compared to females.
- Significance: p-value = 0.000446 (significant at Î± = 0.05).

### Visualization
```{r visualization-sex}
# Visualize the likelihood of territory acquisition by sex
juveniles_data %>%
  ggplot() +
  geom_histogram(aes(x = acquired_terr, y =..count..))

juveniles_data %>%
  group_by(sex) %>%
  ggplot(aes(x = acquired_terr, fill = sex)) + 
  geom_bar() +
    labs(title = "Acquisition of Territory by Sex",
       x = "Acquisition of Territory",
       y = "Number of squirrels")

juveniles_data %>%
  group_by(sex) %>%
  summarise(mean_likelihood = mean(acquired_terr)) %>%
  ggplot(aes(x = sex, y = mean_likelihood, fill = sex)) +
  geom_bar(stat = "identity") +
    labs(title = "Likelihood of Acquiring Territory by Sex",
       x = "Sex",
       y = "Mean Likelihood")
```

#### Results for Prediction 1: 
- **Key Finding**: Female have a higher likelihood of acquiring a territory.


### Prediction 2: Sex is the biggest factor that affects whether they can acquire a territory.
### Lasso Regression with the help of ChatGPT
```{r lasso-regression}
# Prepare data for Lasso regression
# Response variable: Territory acquisition status
response_var <- as.numeric(juveniles_data$acquired_terr)

# Predictor variables: Standardized environmental and individual metrics
predictors <- juveniles_data %>% 
  select(sex01, Std.BD, Std.growth, Std.lynx, Std.hare.fall, 
         Std.mustelid, Std.Cleth, z.density, z.cones) %>% 
  as.matrix()  # Convert to matrix

# Fit a Lasso regression model using cross-validation
set.seed(313)  # For reproducibility
lasso_model <- cv.glmnet(
  x = predictors,           # Predictor matrix
  y = response_var,         # Response variable
  family = "binomial",      # Logistic regression
  alpha = 1,                # Alpha = 1 for Lasso regression
  nfolds = 10               # 10-fold cross-validation
)

# Extract optimal lambda values
optimal_lambda <- lasso_model$lambda.min
lambda_1se <- lasso_model$lambda.1se

# Display the lambda values
cat("Optimal lambda (minimum error):", optimal_lambda, "\n")
cat("Lambda using 1-SE rule:", lambda_1se, "\n")

# Coefficients for the optimal lambda
coef_optimal <- coef(lasso_model, s = "lambda.min")
print(coef_optimal)

# Predictions
# Generate predicted probabilities
predicted_probs <- predict(lasso_model, s = "lambda.min", newx = predictors, 
                           type = "response")

# Generate binary predictions
predicted_classes <- ifelse(predicted_probs > 0.5, 1, 0)

# The coefficients show the effect of how each predictor affects outcome
```

### Visualization of Lasso Coefficients
```{r}
# Extract coefficients for the optimal lambda (lambda.min) 
# from your Lasso model
coef_optimal <- coef(lasso_model, s = "lambda.min")

# Convert coefficients to a data frame
coef_df <- as.data.frame(as.matrix(coef_optimal))
coef_df$Predictor <- rownames(coef_optimal)
rownames(coef_df) <- NULL
colnames(coef_df) <- c("Coefficient", "Predictor")

# Filter out predictors with zero coefficients (excluded by Lasso)
coef_df <- coef_df %>% filter(Coefficient != 0)

# Remove the intercept for cleaner visualization
coef_df <- coef_df %>% filter(Predictor != "(Intercept)")

# Create a bar plot to visualize the impact of predictors
library(ggplot2)
ggplot(coef_df, aes(x = reorder(Predictor, Coefficient), y = Coefficient)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +  # Flip for horizontal bars
  labs(title = "Lasso Regression Coefficients",
       x = "Predictors",
       y = "Coefficient") +
  theme_minimal()
```

### Interpretation of the Lasso Regression
- **Key Predictors Identified**: Birth date (Std.BD), sex, hare abundance (Std.hare.fall), and cone abundance (z.cones).
- **Effects**:
  - Late birth date and male sex reduce the likelihood of acquiring a territory.
  - High hare abundance and food availability (cones) increase the likelihood.

#### Sex is not the biggest factor.

#### Check the p-valus of each predictor.
```{r}
# Model for Std.BD (birth date)
model_StdBD <- glm(acquired_terr ~ Std.BD, family = "binomial", 
                   data = juveniles_data)
summary(model_StdBD)

# Model for Std.hare.fall  (hare abundance in fall)
model_harefall <- glm(acquired_terr ~ Std.hare.fall, family = "binomial", 
                      data = juveniles_data)
summary(model_harefall)

# Model for sex
model_sex <- glm(acquired_terr ~ sex, family = "binomial", 
                 data = juveniles_data)
summary(model_sex)
```

#### Result for Prediction 2: 
- **Key Finding**: Standardized birth date (Std.BD) is the biggest factor that affect whether they can acquire a territory.


### Visualization of Key Relationships
```{r}
# Plot: Territory acquisition vs. Standardized Birth Date (Std.BD)
juveniles_data %>%
  ggplot(aes(x = Std.BD, y = acquired_terr)) + 
  geom_point() +
  labs(title = "Territory acquisition vs Standardized Birth Date",
       x = "Territory Acquisition",
       y = "Std.BD") +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial")
              )

# Plot: Territory acquisition vs. Sex
juveniles_data %>%
  ggplot(aes(x = sex01, y = acquired_terr)) + 
  geom_point() +
  labs(title = "Territory acquisition vs Sex",
       x = "Female = 0, Male = 1",
       y = "Territory Acquisition") +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial")
              )
```


### Find the model that best predict the territory acquisition result
```{r full-logistic-regression}
# Fit a logistic regression model with multiple predictors
model_full <- glm(acquired_terr ~ sex + Std.BD + Std.growth + Std.lynx + 
                    Std.hare.fall + Std.mustelid + Std.Cleth + z.density + 
                    z.cones + z.temp, 
                  family = "binomial", 
                  data = juveniles_data)
# Summarize the model results
summary(model_full)
```


### Combined Effects Model
```{r combined-effects}
# Fit a model with combined effects of predator-prey interactions
model_combined_effects <- glm(acquired_terr ~ Std.mustelid * Std.lynx * 
                                Std.hare.fall * Std.Cleth  * z.density, 
                             family = "binomial", data = juveniles_data)

# Summarize the model results
summary(model_combined_effects)
```


```{r}
# Fit a model incorporating multiple predictors and combined effects
model_full_combined <- glm(acquired_terr ~ sex + Std.BD + Std.growth + 
                             z.cones + Std.mustelid * Std.lynx * 
                             Std.hare.fall * Std.Cleth * z.density, 
                      family = "binomial", 
                      data = juveniles_data)

# Display a summary of the full model 
# to assess predictor and interaction effects
summary(model_full_combined)
```


### Compare Models by AIC
```{r aic-comparison}
aic_values <- data.frame(
  Model = c("Full Combined Model", "Full Model", "Combined Effects Model"),
  AIC = c(
    AIC(model_full_combined),
    AIC(model_full),
    AIC(model_combined_effects)
  )
)

# Sort by AIC in ascending order
aic_values <- aic_values[order(aic_values$AIC), ]
print(aic_values)
```

